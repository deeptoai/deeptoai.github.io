---
layout: post
title: 卡尔曼滤波入门
category: another
---

# 神奇的卡尔曼滤波
最近学习了卡尔曼滤波，看了好多资料，取其精华，去其糟粕，总结如下：

- 解决问题

    已知估计值和测量值，以及估计和测量的误差，那么如何得到较为真实的数值？
- 核心思想

    假设测量和估计的噪声都是符合高斯分布的白噪声，那么一个可行的办法是，将两个噪声的概率密度相乘，得到一个新的概率密度来近似表达真值。注：两个高斯分布概率密度相乘后还是高斯分布。
- 应用场景

    - 观测系统以及估计系统均为线性离散系统
    - 估计噪声和观测噪声均为高斯白噪声
    - 两个符合高斯分布的概率密度相乘后可以融合为一个新的高斯分布。这一点也就是卡尔曼滤波方法的核心。

卡尔曼滤波器又称为最佳线性滤波器。它的好处有很多，比如实现简单，又是纯时域滤波器，不需要进行频域变换。所以在工程上有很多应用。

状态转移：
假设有一辆小车在路上行驶，其状态用二维列向量 xt=[pt  ;vt]表示，pt表示位置，vt表示速度。ut是一个控制量，表示驾驶员柴油门或刹车，ut如果为0，表示车做匀速直线运动。如果知道上一个时刻状态xt-1,那么当前时刻的状态可表示如下

                pt=p(t-1)+v(t-1)*delta.t+ut*delta.t^2/2  (路程公式)；
     vt=vt-1+ut*delta.t;(速度公式)，
                    
可以看到输出变量是输入变量的线性组合，所以我们说卡尔曼滤波是最佳线性滤波器，因为它只能描述状态与状态之间的线性关系。既然是线性关系，那我们可以把它写成矩阵形式：

                [pt;vt]=[1  delta.t; 0  1][p(t-1);vt-1]+[delta.t^2/2; delta.t]ut,
                
在进一步把状态矩阵提取出来

        Ft=[1   delta.t;0  1], Bt=[delta.t^2/2; delta.t],
        
        
公式又可以简化为:
       
        X^t-=FtX^t-1+Btut

 它表示如何从上一个时刻的状态推测当前时刻的状态。F是状态转换矩阵。B表示控制矩阵，它表示控制量U如何作用于当前矩阵。x上有一个尖帽子表示的是估计量而不是X的真实值，因为汽车的真实状态我们是永远无法知道的，只能通过观测尽可能估计X的值。上标减号表示是根据上一个时刻推测来的，待会还要根据观测量去修正X的值，修正之后才是最佳估计值，也就是没有减号上标的X。
 
有了状态估计公式，我们就可以推测当前时刻的状态，但所有推测都是包含噪声的，噪声越大，不确定性就越大，我们如何表示这次推测带来多少不确定性呢？我们要用协方差矩阵来表示（协方差矩阵用来表示不同维度的随机变量之间的关系，），在卡尔曼滤波器中所有不确定性都用协方差矩阵来表示。

噪声协方差矩阵的传递这种不确定性用P来表示


        pt=FPt-1FT+Q

(根据协方差的性质：cov(Ax,Bx)=Acov(x,x)BT）

我们的预测模型不是百分百准确的，也是包含噪声的，所以要加上Q,表示预测模型本身包含的噪声.这就是卡尔曼滤波器五个公式中的第二个公式，表示不确定性在各个时刻之间的传递关系。

观察矩阵

假设我们在公路的一端放置了一个激光测距仪，在每个时刻都可以观测汽车的位置，观测到的值记为Zt,从汽车本身的状态Xt和观测状态Zt之间有一个变换关系，记为观测矩阵H,因为是线性关系，所以H也是矩阵形式.X和Z的维度不一定是相同的，在我们的例子中Z是一个标量，X是一个二维列向量。所以H是一个一行两列的矩阵。
                                            H=[1  0]。
这样H和X相乘的时候得到标量Z。而Z是X的位置，它和X的第一个量是相等的。因为观测也不是百分之百可靠的，所以加一个v表示观测噪声。
Zt=Hxt+v,观测噪声的协方差矩阵用R来表示，因为观测值是一个一个标量，所以协方差也是一维的。如果有仪器能测量多个特征，那么Z就会变为多维列向量，包含多个测量值，而每个测量值都是真实状态的不完全表现。我们可以从几种不完整的表述中推断真实状态，而卡尔曼滤波器的数据融合功能正是在这种测量矩阵中体现出来。

状态更新
    我们已经有了观测量Z，以及它们的噪声R，怎么把它们整合进我们对状态X的估计呢？前面我们已经得到带减号上标的Xt,现在我们只要在它后面加上一项来修正它的值，就可以得到我们的最佳估计值了。
    
                                    X^t=X^-t+Kt(zt-Hx^-t)
                                    
后面的一项Zt-HX^t- 表示实际的观测值和预测的估计值之间的残差，这个残差乘以一个系数K就可以修正x^t-的值了。

这个K十分关键，它叫做卡尔曼系数。实际上它也是一个矩阵。
Kt=P-tHT(HP-tHT+R)-1,
这个公式的推导比较麻烦，我们且定性分析一下，它的作用主要有两个方面。第一权衡两个协方差矩阵的大小，决定是相信预测的模型多一点还是观察的模型多一点。第二是把残差的表现形式从观察域转换到状态域。这是什么意思呢？我们这个例子中，X是二维的，而Z是一维的，卡尔曼系数K就是在替我们做这样一个转换，又因为协方差P中包含了速度，因此K可以对状态X的两个维度同时进行修正。

最后一步了。噪声协方差矩阵的更新

        Pt=(I-KtH)Pt-

这个值是留给下一轮迭代时用的。在这一步里，状态的不确定性是减小的，而在下一轮迭代中，由于传递噪声的引入，不确定性又会增大，卡尔曼滤波就是在这种不确定性当中寻求一种平衡。
卡尔曼滤波的五个公式
预测(通过上一时刻的状态预测当前状态）
X^-t=FX^t-1,But-1

P-t=FPt-1FT+Q

更新
Kt=Pt-Ht(HP-tHT+R)-1
X^t=X^-t+Kt(zt-Hx^-t)
Pt=(I-KtH)Pt-


在Matlab中实现kanlman filter

Z=(1:100);%观测值
noise=randn(1,100);%高斯白噪声
Z=Z+noise;
 
 
X=[0;0]; %初始状态

P=[1 0; 0 1];%噪声的协方差矩阵初始值

%初始状态不是特别重要
 
F=[1 1;0 1];%状态转移矩阵，因为每一秒采样一次，所以delta t=1

Q=[0.0001,0;0 0.0001];%状态转移矩阵的协方差矩阵

H=[1 0];%观测矩阵

R=1;%观测噪声方差
 
figure;

holdon;
 
 

for
i=1:100

   X_=F*X;
   
    P_=F*P*F'+Q;
    
    K=P_*H'/(H*P_*H'+R);
    
    X=X_+K*(Z(i)-H*X_);
    
    P=(eye(2)-K*H)*P_;
   
    plot(X(1),X(2),'.');  
end
 